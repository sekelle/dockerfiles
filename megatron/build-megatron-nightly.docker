FROM base-net:rocm702

ARG MI_TARGET

# Repository for the wheel files
RUN set -eux ; \
  mkdir /opt/wheels
  
#
# Install pytorch
# 

# PyTorch comes with RCCL from ROCm 6.0.0 which cause a segmentation fault 
# in the tests. It's supspected it's related to https://github.com/ROCm/rccl/pull/1153
# Copying the RCCL library from /opt/rocm, solve the issue.

ENV PYTORCH_ROCM_ARCH ${MI_TARGET}
ARG PYTORCH_VERSION
ARG PYTORCH_DEBUG
ARG PYTORCH_RELWITHDEBINFO

RUN  set -eux ; \
  pip install --break-system-packages --pre torch --index-url https://download.pytorch.org/whl/nightly/rocm7.0

RUN  set -eux ; \
  python3 -c 'import torch; print(torch.__file__)'

RUN  set -eux ; \
  cp /opt/rocm/lib/librccl.so $(dirname $(python3 -c 'import torch; print(torch.__file__)'))/lib
  
#
# Pytorch dependencies
#
RUN  set -eux ; \
  pip install --break-system-packages packaging ninja pillow cmake pyyaml

ARG APEX_VERSION
RUN  set -eux ; \
  cd / ; \
  rm -rf /opt/mybuild ; \
  git clone --recursive https://github.com/rocm/apex /opt/mybuild ; \
  cd /opt/mybuild ; \
  git checkout -b mydev $APEX_VERSION ; \
  git submodule sync ; \
  git submodule update --init --recursive  ; \
  \
  TORCH_DONT_CHECK_COMPILER_ABI=1 \
    CC=clang \
    CXX=clang++ \
    nice python3 setup.py bdist_wheel --cpp_ext --cuda_ext ; \
  \
  cp -rf dist/* /opt/wheels ; \
  rm -rf /opt/mybuild
  
RUN  set -eux ; \
  pip install --break-system-packages /opt/wheels/apex-*.whl

ARG TORCHVISION_VERSION
RUN  set -eux ; \
  pip install --break-system-packages --pre torchvision --index-url https://download.pytorch.org/whl/nightly/rocm7.0

#
# AMD-SMI
#
RUN  set -eux ; \
  cd $ROCM_PATH/share/amd_smi ; \
  python3 -m pip wheel . --wheel-dir=/opt/wheels ; \
  pip install --break-system-packages /opt/wheels/amdsmi-*.whl

ARG TORCHDATA_VERSION
RUN  set -eux ; \
  pip install --break-system-packages --pre torchdata --index-url https://download.pytorch.org/whl/nightly/rocm7.0
   
ARG TORCHTEXT_VERSION
RUN  set -eux ; \
  pip install --break-system-packages --pre torchtext --index-url https://download.pytorch.org/whl/nightly/rocm7.0

ARG TORCHAUDIO_VERSION
RUN  set -eux ; \
  pip install --break-system-packages --pre torchaudio --index-url https://download.pytorch.org/whl/nightly/rocm7.0

#
# Deepspeed
#
RUN set -eux ;   apt-get update ;   apt-get -y install     rustc python3.12-venv ;   apt-get clean ;   rm -rf /var/lib/apt/lists/* ;   true

ARG DEEPSPEED_VERSION
RUN  set -eux ; \
  CC=gcc CXX=g++ \
  DS_BUILD_AIO=0 \
  DS_BUILD_CCL_COMM=1 \
  DS_BUILD_CPU_ADAM=1 \
  DS_BUILD_CPU_LION=1 \
  DS_BUILD_EVOFORMER_ATTN=0 \
  DS_BUILD_FUSED_ADAM=1 \
  DS_BUILD_FUSED_LION=1 \
  DS_BUILD_CPU_ADAGRAD=0 \
  DS_BUILD_FUSED_LAMB=1 \
  DS_BUILD_QUANTIZER=0 \
  DS_BUILD_RANDOM_LTD=0 \
  DS_BUILD_SPARSE_ATTN=0 \
  DS_BUILD_TRANSFORMER=0 \
  DS_BUILD_TRANSFORMER_INFERENCE=0 \
  DS_BUILD_TRANSFORMER_INFERENCE=0 \
  DS_BUILD_STOCHASTIC_TRANSFORMER=1 \
  DS_ACCELERATOR=cuda \
  pip install --break-system-packages deepspeed==$DEEPSPEED_VERSION --global-option="build_ext" --global-option="-j32" ; \
#  ds_report ; \
  true

#
# flash-attention
#
ARG FLASH_ATTENTION_VERSION
RUN  set -eux ; \
  git clone -b $FLASH_ATTENTION_VERSION --recursive https://github.com/Dao-AILab/flash-attention /opt/mybuild ; \
  cd /opt/mybuild ; \
  cp -rf benchmarks /opt/wheels/flash_attn-benchmarks ; \
  \
  rm -rf build ; \
  MAX_JOBS=32 \
  CC=gcc \
  CXX=g++ \
  GPU_ARCHS=${MI_TARGET} \
    python3 setup.py bdist_wheel ; \
  cp -rf dist/* /opt/wheels ; \
  \
  rm -rf /opt/mybuild 

RUN  set -eux ; \
  pip install --break-system-packages /opt/wheels/flash_attn-*.whl

#
# xformers
#
ARG XFORMERS_VERSION
RUN  set -eux ; \
  git clone --recursive https://github.com/ROCm/xformers /opt/mybuild ; \
  cd /opt/mybuild ; \
  git checkout -b mydev $XFORMERS_VERSION ; \
  git submodule sync ; \
  git submodule update --init --recursive  ; \
  \
  rm -rf build ; \
  CC=gcc \
  CXX=g++ \
  HIP_ARCHITECTURES="${MI_TARGET}" \
  PYTORCH_ROCM_ARCH="${MI_TARGET}" \
  python3 setup.py bdist_wheel ; \
  cp -rf dist/* /opt/wheels ; \
  \
  rm -rf /opt/mybuild 

RUN  set -eux ; \
  pip install --break-system-packages /opt/wheels/xformers-*.whl

RUN  set -eux ; \
  pip install --break-system-packages \
    scipy==1.12.0 \
    matplotlib==3.8.2 \
    pandas==2.2.2 \
    seaborn==0.13.2

# 
# Bits and bytes
#
ARG BITS_AND_BYTES_VERSION
RUN  set -eux ; \ 
  git clone https://github.com/ROCm/bitsandbytes /opt/mybuild ; \
  cd /opt/mybuild ; \
  git checkout -b mydev $BITS_AND_BYTES_VERSION ; \
  cmake -DCOMPUTE_BACKEND=hip -DBNB_ROCM_ARCH="${MI_TARGET}" -S . ; \
  nice make -j ; \
  python3 setup.py bdist_wheel ; \
  cp dist/bitsandbytes-*.whl /opt/wheels ; \
  \
  cd / ; \
  rm -rf /opt/mybuild ; \
  true

RUN  set -eux ; \ 
  pip install --break-system-packages /opt/wheels/bitsandbytes-*.whl

#
# Some other packages we may need
#
RUN  set -eux ; \
  pip install --break-system-packages \
    'numpy<2' \
    transformers==4.46.3 \
    sentencepiece==0.2.0 \
    protobuf==5.27.1 \
    accelerate==0.34.2 \
    tensorboard==2.18.0 \
    openpyxl==3.1.5 

#
# VLLM
#
RUN  set -eux ; \ 
  pip install --break-system-packages \
    setuptools_scm ; \
  pip install --break-system-packages --upgrade \ 
    setuptools>=77.0.3

ARG VLLM_VERSION
RUN set -eux ; \
  git clone --recursive -b $VLLM_VERSION https://github.com/vllm-project/vllm /opt/mybuild ; \
  \
  cd /opt/mybuild ; \
  CC=gcc \
    CXX=g++ \
    python3 setup.py bdist_wheel --dist-dir=/opt/wheels ; \
  \
  rm -rf /opt/mybuild

RUN  set -eux ; \
  pip install --break-system-packages \
    /opt/wheels/vllm-*.whl

#
# LLVM compression dependencies 
#

ARG TRITON_LLVM_VERSION
RUN  set -eux ; \
  git clone https://github.com/llvm/llvm-project /opt/llvm-project ; \
  cd /opt/llvm-project ; \
  git checkout -b mydev $TRITON_LLVM_VERSION ; \
  \
  mkdir /opt/llvm-project/build ; \
  cd /opt/llvm-project/build ; \
  \
  cmake -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_PROJECTS="mlir;llvm;lld" \
    -DLLVM_TARGETS_TO_BUILD="host;NVPTX;AMDGPU" \
    -DCMAKE_CXX_COMPILER=g++ \
    -DCMAKE_C_COMPILER=gcc \
    ../llvm ; \
  ninja ; \
  \
  # for i in /opt/llvm-project/* ; do \
  #   if [ $i = "/opt/llvm-project/build" ] ; then continue ; else rm -rf $i ; fi ; \
  # done ; \
  true

ARG TRITON_FINAL_LLVM_VERSION
RUN  set -eux ; \
  git clone https://github.com/triton-lang/llvm-project /opt/llvm-project-final ; \
  cd /opt/llvm-project-final ; \
  git checkout -b mydev $TRITON_FINAL_LLVM_VERSION ; \
  \
  mkdir /opt/llvm-project-final/build ; \
  cd /opt/llvm-project-final/build ; \
  \
  cmake -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DLLVM_ENABLE_PROJECTS="mlir;llvm;lld" \
    -DLLVM_TARGETS_TO_BUILD="host;NVPTX;AMDGPU" \
    -DCMAKE_CXX_COMPILER=g++ \
    -DCMAKE_C_COMPILER=gcc \
    ../llvm ; \
  ninja ; \
  \
  # for i in /opt/llvm-project-final/* ; do \
  #   if [ $i = "/opt/llvm-project-final/build" ] ; then continue ; else rm -rf $i ; fi ; \
  # done ; \
  true

#
# Triton that AOTRITON uses is built by it, so we used the final one
# Note that there is already triton that came with Pytorch.
#
# Use this LLVM so that aotriton works.
ENV LLVM_BUILD_DIR=/opt/llvm-project/build
ENV LLVM_INCLUDE_DIRS=$LLVM_BUILD_DIR/include
ENV LLVM_LIBRARY_DIR=$LLVM_BUILD_DIR/lib
ENV LLVM_SYSPATH=$LLVM_BUILD_DIR

ARG TRITON_VERSION
RUN  set -eux ; \
  git clone --recursive https://github.com/rocm/triton /opt/mybuild ; \
  cd /opt/mybuild ; \
  \
  git checkout -b mydev $TRITON_VERSION ; \
  git submodule sync ; \
  git submodule update --init --recursive ; \
  \
  CC=gcc \
    CXX=g++ \
    pip wheel --no-deps -e . -w /opt/wheels ; \
    cd / ; rm -rf /opt/mybuild

# RUN  set -eux ; \
#     pip install --break-system-packages /opt/wheels/triton-*.whl ; \
#     true

# Use this LLVM so that aotriton works.
ENV LLVM_BUILD_DIR=/opt/llvm-project-final/build
ENV LLVM_INCLUDE_DIRS=$LLVM_BUILD_DIR/include
ENV LLVM_LIBRARY_DIR=$LLVM_BUILD_DIR/lib
ENV LLVM_SYSPATH=$LLVM_BUILD_DIR

ARG TRITON_FINAL_VERSION
RUN  set -eux ; \
  git clone --recursive https://github.com/triton-lang/triton /opt/mybuild ; \
  cd /opt/mybuild ; \
  git checkout -b mydev $TRITON_FINAL_VERSION ; \
  git submodule sync ; \
  git submodule update --init --recursive ; \
  cd /opt/mybuild ; \
  CC=gcc \
    CXX=g++ \
    pip wheel --no-deps -e . -w /opt/wheels ; \
    cd / ; rm -rf /opt/mybuild

# Install after aotriton is built so it does not conflict.
# RUN  set -eux ; \
#     pip install --break-system-packages /opt/wheels/triton-*.whl ; \
#     true

#
# AOTRITON for TE
# 
ENV LLVM_BUILD_DIR=/opt/llvm-project/build
ENV LLVM_INCLUDE_DIRS=$LLVM_BUILD_DIR/include
ENV LLVM_LIBRARY_DIR=$LLVM_BUILD_DIR/lib
ENV LLVM_SYSPATH=$LLVM_BUILD_DIR

ARG AOTRITON_VERSION
RUN  set -eux ; \
  git clone --recursive https://github.com/ROCm/aotriton /opt/mybuild; \
  \
  cd /opt/mybuild ; \
  git checkout -b mydev $AOTRITON_VERSION ; \
  git submodule sync ; \
  git submodule update --init --recursive ; \
  \
  cd /opt/mybuild ; \
  mkdir /opt/mybuild/build ; \
  cd /opt/mybuild/build ; \
  \
  # echo '#!/bin/bash -eux' > clang++ ; \
  # echo 'exec $ROCM_PATH/llvm/bin/clang++ -Wno-deprecated-declarations $@' >> clang++ ; \
  # chmod +x clang++ ; \
  # export PATH=$(pwd):$PATH ; \
  \
  cmake .. \
    -DCMAKE_INSTALL_PREFIX=/opt/aotriton \
    -DCMAKE_BUILD_TYPE=Release \
    -DAOTRITON_GPU_BUILD_TIMEOUT=0 \
    -DAOTRITON_TARGET_ARCH=${MI_TARGET} \
    -DAMDGPU_TARGETS=${MI_TARGET} \
    -G Ninja \
    -DCMAKE_CXX_COMPILER=g++ \
    -DCMAKE_C_COMPILER=gcc ; \
  \
  ninja install ; \
  \
  cd / ; rm -rf /opt/mybuild

ENV LD_LIBRARY_PATH /opt/aotriton/lib:$LD_LIBRARY_PATH

#
# Add aiter for vLLM
#
ARG AITER_VERSION
RUN  set -eux ; \
  rm -rf /opt/mybuild ;\
  git clone https://github.com/ROCm/aiter /opt/mybuild ; \
  cd /opt/mybuild ; \
  git checkout -b mydev $AITER_VERSION ; \
  git submodule sync ; \
  git submodule update --init --recursive ; \
#  sed -i 's#{__package__}.{md_name}#private_{__package__}.{md_name}#g' aiter/jit/core.py ; \
  CC=clang \
  CXX=clang++ \
    python3 setup.py bdist_wheel --dist-dir=/opt/wheels ; \
  cd / ; rm -rf /opt/mybuild

RUN  set -eux ; \
  pip install --break-system-packages /opt/wheels/aiter*.whl

#
# Transformer engine
#
ARG TE_VERSION

ENV NVTE_FRAMEWORK pytorch
ENV NVTE_ROCM_ARCH gfx942
ENV NVTE_AOTRITON_PATH /opt/aotriton

RUN  set -eux ; \
  pip install --break-system-packages cmake==3.31.6

ARG MI_NAME
RUN  set -eux ; \
  if [[ "${MI_NAME}" == "MI2"* ]] ; then export NVTE_FUSED_ATTN_CK=0 ; fi ; \
  if [[ "${MI_NAME}" == "MI300A"* ]] ; then export CU_NUM=228 ; fi ; \
  if [[ "${MI_NAME}" == "MI300X"* ]] ; then export CU_NUM=304 ; fi ; \
  \
  export GPU_TARGETS=$MI_TARGET ; \
  export TARGET_GPUS=$MI_NAME  ; \
  rm -rf /opt/mybuild ; \
  git clone --recursive https://github.com/ROCm/TransformerEngine.git /opt/mybuild ; \
  cd /opt/mybuild ; \
  git checkout -b mydev $TE_VERSION ; \
  git submodule sync ; \
  git submodule update --init --recursive ; \
  \
  echo '#!/bin/bash -eux' > clang++ ; \
  echo 'exec $ROCM_PATH/llvm/bin/clang++ -Wno-c++11-narrowing $@' >> clang++ ; \
  chmod +x clang++ ; \
  export PATH=$(pwd):$PATH ; \
  \
  sed -i 's/_TEprivate//g' /opt/mybuild/transformer_engine/common/CMakeLists.txt ; \
  CC=clang \
    CXX=clang++ \
    TORCH_DONT_CHECK_COMPILER_ABI=1 \
    pip wheel --no-deps --verbose -e . -w /opt/wheels ; \
  rm -rf /opt/mybuild

RUN  set -eux ; \
  pip install --break-system-packages \
    /opt/wheels/transformer_engine-*.whl

# force all RCCL streams to be high priority
ENV TORCH_NCCL_HIGH_PRIORITY 1
ENV RCCL_MSCCL_ENABLE 0

RUN  set -eux ; \
  CC=gcc \
  CXX=g++ \
  pip install --break-system-packages \
    scipy \
    einops \
    flask-restful \
    nltk \
    pytest \
    pytest-cov \
    pytest_mock \
    pytest-csv \
    pytest-random-order \
    sentencepiece \
    wrapt \
    zarr \
    wandb \
    tensorstore==0.1.45 \
    pytest_mock \
    pybind11 \
    setuptools \
    datasets \
    tiktoken \
    pynvml

RUN  set -eux ; \
  pip install --break-system-packages "huggingface_hub[cli]"

ENV CAUSAL_CONV1D_FORCE_BUILD=TRUE
ENV MAMBA_FORCE_BUILD=TRUE
ENV HIP_ARCHITECTURES=${MI_TARGET}

RUN  set -eux ; \
  rm -rf /opt/mybuild ;\
  git clone https://github.com/Dao-AILab/causal-conv1d /opt/mybuild ; \
  cd /opt/mybuild ; \
  CC=gcc- \
  CXX=g++ \
    python3 setup.py bdist_wheel --dist-dir=/opt/wheels ; \
  cd / ; rm -rf /opt/mybuild

RUN  set -eux ; \
  rm -rf /opt/mybuild ;\
  git clone https://github.com/state-spaces/mamba /opt/mybuild ; \
  cd /opt/mybuild ; \
  CC=gcc \
  CXX=g++ \
    python3 setup.py bdist_wheel --dist-dir=/opt/wheels ; \
  cd / ; rm -rf /opt/mybuild

# For transformer engine.
ENV NVTE_USE_HIPBLASLT=1

RUN  set -eux ; \
  rm -rf /opt/mybuild ;\
  git clone https://github.com/caaatch22/grouped_gemm.git /opt/mybuild ; \
  cd /opt/mybuild ; \
  git checkout rocm ; \
  git submodule sync ; \
  git submodule update --init --recursive  ; \
  CC=gcc \
  CXX=g++ \
    python3 setup.py bdist_wheel --dist-dir=/opt/wheels ; \
  cd / ; rm -rf /opt/mybuild

RUN  set -eux ; \
  pip install --break-system-packages /opt/wheels/causal_conv1d-*.whl ; \
  true

RUN  set -eux ; \
  pip install --break-system-packages /opt/wheels/mamba_ssm-*.whl ; \
  true

RUN  set -eux ; \
  pip install --break-system-packages /opt/wheels/grouped_gemm-*.whl ; \
  true
ARG MEGATRON_VERSION
RUN  set -eux ; \
  rm -rf /opt/mybuild ;\
  git clone https://github.com/ROCm/Megatron-LM.git /opt/mybuild ; \
  cd /opt/mybuild ; \
  git checkout -b mydev $MEGATRON_VERSION ; \
  git submodule sync ; \
  git submodule update --init --recursive  ; \
  CC=gcc \
  CXX=g++ \
    python3 setup.py bdist_wheel --dist-dir=/opt/wheels ; \
  cd / ; rm -rf /opt/mybuild

RUN  set -eux ; \
  pip install --break-system-packages /opt/wheels/megatron_core-*.whl ; \
  true

#
# Use Pytorch triton LLVM version
#
ENV LLVM_BUILD_DIR=/opt/llvm-project-final/build
ENV LLVM_INCLUDE_DIRS=$LLVM_BUILD_DIR/include
ENV LLVM_LIBRARY_DIR=$LLVM_BUILD_DIR/lib
ENV LLVM_SYSPATH=$LLVM_BUILD_DIR

RUN  set -eux ; \
    pip install --break-system-packages /opt/wheels/triton-*git${TRITON_FINAL_VERSION:0:8}*.whl

RUN  set -eux ; \
  cd $(dirname $(python3 -c "import torch; print(torch.__file__)"))/lib ; \
  for i in * ; do if [ -f /opt/rocm/lib/$i ] ; then rm $i ; fi ; done ; \
  for i in * ; do if [ -d /opt/rocm/lib/$i ] ; then rm -rf $i ; fi ; done

RUN  set -eux ; \
  cd $(dirname $(python3 -c "import torch; print(torch.__file__)"))/lib ; \
  for i in * ; do if [ -f /opt/amdgpu/lib64/$i ] ; then rm $i ; fi ; done

ARG TORCHAO_VERSION
RUN  set -eux ; \
  pip install --break-system-packages --pre torchao --index-url https://download.pytorch.org/whl/nightly/rocm7.0
  
ARG TORCHTUNE_VERSION
RUN  set -eux ; \
  git clone -b $TORCHTUNE_VERSION --recursive https://github.com/pytorch/torchtune /opt/mybuild ; \
  cd /opt/mybuild ; \
  pip wheel --no-deps -e . -w /opt/wheels ; \
  pip install --break-system-packages /opt/wheels/torchtune-*.whl ; \
  cd / ; rm -rf /opt/mybuild

RUN  set -eux ; \
  CC=gcc \
  CXX=g++ \
  pip install --break-system-packages \
    beautifulsoup4==4.13.3 \
    lightning==2.5.1 \
    evaluate==0.4.3 \
    fasttext==0.9.3 \
    scikit-learn==1.6.1 \
    scikit-image==0.25.2 \
    gradio==5.23.1 \
    numba==0.61.2 \
    pyrsmi==0.2.0 \
    pysqlite3==0.5.4 \
    sentence-transformers==3.4.1 \
    tensorboardX==2.6.2.2 \
    torch-tb-profiler==0.4.3 \
    tornado==6.4.2 \
    tqdm-multiprocess==0.0.11 \
    zstandard==0.23.0

RUN  set -eux ; \
  CC=gcc \
  CXX=g++ \
  pip install --break-system-packages omegaconf==2.4.0.dev3

RUN  set -eux ; \
  git clone https://github.com/huggingface/lighteval /opt/mybuild ; \
  cd /opt/mybuild ; \
  CC=gcc \
  CXX=g++ \
  pip wheel --no-deps -e . -w /opt/wheels ; \
  cd / ; rm -rf /opt/mybuild

RUN  set -eux ; \
  CC=gcc \
  CXX=g++ \
  pip install --break-system-packages /opt/wheels/lighteval*.whl ; true

# RUN  set -eux ; \
#   export CC=gcc; \
#   export CXX=g++; \
#   pip install --break-system-packages /opt/wheels/aiter*.whl ; \
#   pip install --break-system-packages pybind11==3.0.1

RUN set -eux ; \
  apt-get update ; \
  apt-get -y install \
    locales ; \
  apt-get clean ; \
  rm -rf /var/lib/apt/lists/* ; \
  true

RUN set -eux ; \
  locale-gen en_US.UTF-8 ; \
  update-locale LANG=en_US.UTF-8 

RUN set -eux ; \
    echo '#!/bin/bash' > /entry.sh ; \
    echo 'PATH='"$PATH"' exec "$@"' >> /entry.sh ; \
    chmod +x /entry.sh

ENTRYPOINT [ "/entry.sh" ]
CMD [ "/bin/bash" ]
